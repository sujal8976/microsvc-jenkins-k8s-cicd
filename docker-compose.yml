services:
  mongo:
    image: mongo:latest
    volumes:
      - mongo_data:/data/db
    restart: unless-stopped
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:alpine
    volumes:
      - redis_data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  auth-service:
    build:
      context: .
      dockerfile: auth-service/Dockerfile
    image: devsujal/auth-service:latest
    environment:
      - PORT=3001
      - MONGODB_URI=mongodb://mongo:27017/auth_db
      - JWT_SECRET=your_jwt_secret_key_min_32_chars_long
      - JWT_REFRESH_SECRET=your_jwt_refresh_secret_key_min_32_chars_long
      - JWT_ACCESS_EXPIRE=15m
      - JWT_REFRESH_EXPIRE=7d
      - NODE_ENV=production
    depends_on:
      mongo:
        condition: service_healthy

  app-service:
    build:
      # Build from the repository root so the `frontend/` directory is
      # available to the Docker build context. This allows the Dockerfile
      # to COPY frontend files from `frontend/`.
      context: .
      dockerfile: app-service/Dockerfile
    image: devsujal/app-service:latest
    env_file:
      - .env.aws
    environment:
      - PORT=3002
      - MONGODB_URI=mongodb://mongo:27017/app_db
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - AUTH_SERVICE_URL=http://auth-service:3001
      - NODE_ENV=production
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy

  worker-service:
    build:
      context: .
      dockerfile: worker-service/Dockerfile
    image: devsujal/worker-service:latest
    env_file:
      - .env.aws
    environment:
      - MONGODB_URI=mongodb://mongo:27017/app_db
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - NODE_ENV=production
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  gateway-service:
    build:
      context: .
      dockerfile: gateway-service/Dockerfile
    image: devsujal/gateway-service:latest
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - AUTH_SERVICE_URL=http://auth-service:3001
      - APP_SERVICE_URL=http://app-service:3002
      - NODE_ENV=production
    depends_on:
      - auth-service
      - app-service

volumes:
  mongo_data:
  redis_data:


